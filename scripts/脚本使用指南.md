# AutoSEP 脚本使用指南

## 概述

AutoSEP 提供三个运行脚本，都读取 `config.yaml` 配置文件，支持后台运行：

| 脚本 | 功能 | 日志前缀 |
|------|------|----------|
| `run_pipeline.sh` | 完整流程（优化 + 评估） | `pipeline_` |
| `run_autosep_optimize.sh` | 仅 Prompt 优化 | `optimize_` |
| `run_classification.sh` | 仅分类评估 | `classify_` |

## 脚本位置

```
/home/hdl/project/autosep/scripts/
├── run_pipeline.sh           # 完整流程
├── run_autosep_optimize.sh   # 仅 Prompt 优化
├── run_classification.sh     # 仅分类评估
└── config.yaml               # 配置文件
```

## 执行流程

```
┌─────────────────────────────────────────────────────────────┐
│                    run_pipeline.sh                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 环境检查                                                 │
│     - 检查 config.yaml 是否存在                              │
│     - 检查 yq 工具是否安装                                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 读取配置                                                 │
│     - 路径配置 (data_dir, gpu)                               │
│     - 数据集名称 (dataset)                                   │
│     - AutoSEP 参数 (n_train, rounds, beam_size 等)          │
│     - Classification 参数 (mode, n_test 等)                 │
│     - 实验编号 (out_num)                                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 设置 GPU                                                 │
│     - 读取 config.yaml 中的 paths.gpu                        │
│     - 设置 CUDA_VISIBLE_DEVICES 环境变量                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Step 1: AutoSEP 优化 (autosep/main.py)                  │
│     - 加载初始 Prompt                                        │
│     - 为训练集生成属性描述                                    │
│     - 多轮优化循环，生成改进的 Prompt                         │
│     - 输出: 优化后的 Prompt + 属性缓存 JSON                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. Step 2: 分类评估 (classification.py)                    │
│     - 加载优化后的 Prompt                                    │
│     - 对测试集进行分类预测                                    │
│     - 计算 Accuracy / F1                                     │
│     - 输出: 评估结果 TXT 文件                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 输出结果摘要                                             │
│     - 显示结果文件路径                                        │
│     - 显示 Accuracy / F1 分数                                │
└─────────────────────────────────────────────────────────────┘
```

## 配置文件说明

配置文件位于 `scripts/config.yaml`，主要配置项：

### 路径配置

```yaml
paths:
  data_dir: ./datasets  # 数据集目录 (相对于项目根目录)
  gpu: 3                # GPU 编号，设置 CUDA_VISIBLE_DEVICES
```

### 数据集配置

```yaml
dataset: cub  # 数据集简称
# 细粒度分类: cub, dog, flower, car, pet, aircraft, food, birdsnap
# 通用分类:   caltech101, caltech256, dtd, eurosat, ucf, sun397
# ImageNet:   imagenet_1k, imagenet_a, imagenet_r, imagenet_sketch, imagenet_v2
```

**支持的 19 个数据集**:

| 类型 | 数据集 |
|------|--------|
| 细粒度分类 | cub, dog, flower, car, pet, aircraft, food, birdsnap |
| 通用分类 | caltech101, caltech256, dtd, eurosat, ucf, sun397 |
| ImageNet | imagenet_1k, imagenet_a, imagenet_r, imagenet_sketch, imagenet_v2 |

**注意**: 通用数据集使用默认的 prompt 模板，原有任务使用 `prompts/` 目录下的专用模板。

运行时会自动输出数据集详细信息：
```
============================================================
配置信息
============================================================
数据集简称: cub
目录名: CUB_200_2011
全称: CUB-200-2011
类别数: 200
类型: 鸟类细粒度分类
路径: /home/hdl/project/autosep/datasets/CUB_200_2011 ✓
```

### AutoSEP 优化参数

```yaml
autosep:
  n_train: 30              # 训练样本数（每类）
  n_val: 30                # 验证样本数（每类）
  n_test: 30               # 测试样本数（每类）
  rounds: 6                # 优化轮数
  beam_size: 4             # Beam Search 宽度
  minibatch_size: 50       # Mini-batch 大小
  n_gradients: 4           # 梯度数量
  mc_samples_per_step: 1   # Monte Carlo 采样数
  max_expansion_factor: 5  # 最大扩展因子
  test_eval: true          # 是否在测试集上评估
  temperature: 0.0         # 生成温度
  max_threads: 8           # 最大线程数
  train_ratio: 100.0       # 调试用: 使用训练集的百分比 (1-100)
```

### 分类评估参数

```yaml
classification:
  mode: test           # 评估模式 (test/val)
  n_test: 30           # 测试样本数（每类）
  prompt_idx: 0        # Prompt 索引
  parallel: true       # 是否并行
  generate: true       # 是否生成属性
  attributes: true     # 是否使用属性
  temperature: 0.0     # 生成温度
  max_threads: 8       # 最大线程数
  test_ratio: 100.0    # 调试用: 使用测试集的百分比 (1-100)
```

### 调试比例说明

`train_ratio` 和 `test_ratio` 用于加速调试：

| 参数 | 作用 | 示例 |
|------|------|------|
| `train_ratio: 10.0` | 只用 10% 训练集做优化 | n_train=30 → 实际用 3 |
| `test_ratio: 10.0` | 只用 10% 测试集做评估 | n_test=30 → 实际用 3 |

**调试时**：设为 `10.0` 快速验证流程  
**正式运行**：设为 `100.0` 使用全部数据

### 实验编号

```yaml
experiment:
  out_num: 1  # 实验编号，用于区分不同实验
```

## 使用方法

### 1. 修改配置

```bash
vim scripts/config.yaml
```

主要修改：
- `environment.conda_path`: conda 安装路径
- `environment.conda_env`: conda 环境名称
- `dataset`: 设置要处理的数据集
- `model`: 设置使用的模型
- `paths.gpu`: 设置使用的 GPU 编号
- `experiment.out_num`: 设置实验编号

### 2. 运行脚本

#### 完整流程（优化 + 评估）

```bash
# 后台运行（默认，推荐）
bash scripts/run_pipeline.sh

# 前台运行（用于调试）
bash scripts/run_pipeline.sh -f
```

#### 仅 Prompt 优化

```bash
# 后台运行
bash scripts/run_autosep_optimize.sh

# 前台运行
bash scripts/run_autosep_optimize.sh -f
```

#### 仅分类评估

```bash
# 后台运行（需先完成优化）
bash scripts/run_classification.sh

# 前台运行
bash scripts/run_classification.sh -f
```

### 推荐工作流程

```
1. 调试阶段（快速验证）
   ├── 设置 train_ratio: 10.0, test_ratio: 10.0
   ├── 运行 run_autosep_optimize.sh -f  # 前台运行，观察输出
   └── 确认无误后进入正式阶段

2. 正式运行
   ├── 设置 train_ratio: 100.0, test_ratio: 100.0
   ├── 运行 run_autosep_optimize.sh     # 后台运行优化
   ├── 优化完成后，运行 run_classification.sh  # 后台运行评估
   └── 或直接运行 run_pipeline.sh       # 一键完成全流程
```

**注意**：`run_classification.sh` 需要先运行 `run_autosep_optimize.sh` 生成属性缓存文件。

### 3. 查看日志

```bash
# 完整流程日志
tail -f logs/pipeline_cub.log

# 优化日志
tail -f logs/optimize_cub.log

# 分类评估日志
tail -f logs/classify_cub.log

# 日志文件命名规则：
# - {prefix}_{dataset}.log        # 首次运行
# - {prefix}_{dataset}(1).log     # 第二次运行
```

### 4. 查看结果

```bash
# 结果文件位置
cat autosep/results/{out_num}_{dataset}/evaluate/{out_num}_{dataset}_*.txt

# 查看所有实验的准确率
grep "Accuracy" autosep/results/*/evaluate/*.txt
```

## 输出文件

脚本运行后会生成以下文件：

```
autosep/results/{out_num}_{dataset}/
├── apo_multi_{dataset}_{out_num}.txt   # 优化后的 Prompt（重要！）
├── {out_num}_train_attr.json           # 训练集属性缓存
├── {out_num}_test_attr.json            # 测试集属性缓存
└── evaluate/
    └── {out_num}_{dataset}_*.txt       # 分类评估结果
```

### 文件说明

| 文件 | 生成阶段 | 说明 |
|------|----------|------|
| `apo_multi_{dataset}_{out_num}.txt` | Prompt 优化 | 包含优化后的 Prompt 模板 |
| `{out_num}_train_attr.json` | Prompt 优化 | 训练集图片的属性描述缓存 |
| `{out_num}_test_attr.json` | Prompt 优化 | 测试集图片的属性描述缓存 |
| `evaluate/*.txt` | 分类评估 | 分类准确率、F1 等指标 |

### 示例

```bash
# CUB 数据集，实验编号 1 的结果
autosep/results/1_cub/
├── apo_multi_cub_1.txt          # 优化后的 Prompt
├── 1_train_attr.json            # 训练集属性
├── 1_test_attr.json             # 测试集属性
└── evaluate/
    └── 1_cub_0_1.txt            # 分类评估结果
```

## 依赖要求

- **Python 3.9+**
- **yq**: 用于解析 YAML 配置文件
  ```bash
  pip install yq
  # 或
  conda install -c conda-forge yq
  ```
- **CUDA**: 需要 GPU 支持

## 常见问题

### Q: 如何指定使用的 GPU？

修改 `config.yaml` 中的 `paths.gpu` 参数：

```yaml
paths:
  gpu: 0  # 使用 GPU 0
  # gpu: 0,1  # 使用多个 GPU
```

### Q: 如何更换数据集？

修改 `config.yaml` 中的 `dataset` 参数：

```yaml
dataset: dog  # 切换到 Stanford Dogs 数据集
```

### Q: 如何调整优化轮数？

修改 `config.yaml` 中的 `autosep.rounds` 参数：

```yaml
autosep:
  rounds: 10  # 增加到 10 轮
```

## 脚本核心逻辑

1. **环境检查**: 确保配置文件存在且 yq 工具可用
2. **配置解析**: 使用 yq 解析 YAML 配置文件
3. **GPU 设置**: 根据配置设置 `CUDA_VISIBLE_DEVICES`
4. **AutoSEP 优化**: 调用 `autosep/main.py` 进行 Prompt 优化
5. **分类评估**: 调用 `classification.py` 进行分类评估
6. **结果输出**: 显示结果文件路径和评估指标
