# AutoSEP 代码执行流程与数据集指南

## 一、项目结构

```
autosep/
├── autosep/                    # AutoSEP 核心代码
│   ├── main.py                 # AutoSEP 优化入口
│   ├── optimizers.py           # Prompt 优化器
│   ├── scorers.py              # 评分器
│   └── llm_text_compare.py     # 文本对比评估
├── data/                       # 数据集处理模块
│   ├── __init__.py
│   ├── dataset_config.py      # 数据集名称映射配置
│   └── dataset_loader.py      # 通用数据集加载器
├── datasets/                   # 数据集目录（软链接到实际数据）
│   ├── CUB_200_2011/          # CUB 鸟类数据集
│   ├── dogs_120/              # Stanford Dogs
│   └── ...                    # 其他数据集
├── models/                     # 模型目录
│   └── Qwen/                  # Qwen 模型目录
│       ├── Qwen2.5-VL-7B-Instruct/  # Qwen2.5-VL 模型
│       └── Qwen3-VL-8B-Instruct/    # Qwen3-VL 模型
├── scripts/                    # 运行脚本
│   ├── config.yaml            # 配置文件
│   └── run_pipeline.sh        # 一键运行脚本
├── prompts/                    # Prompt 模板
├── classification.py           # 分类评估脚本
├── tasks.py                    # 原有任务定义（兼容旧任务）
├── predictors.py               # 预测器
├── generator.py                # 属性生成器
├── get_utils.py                # 任务/预测器获取工具
└── api_utils.py                # 模型调用接口
```

## 二、执行流程

### 2.1 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        AutoSEP Pipeline                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 0: 环境准备                                                │
│  - conda create -n autosep python=3.9                           │
│  - pip install -r requirements.txt                              │
│  - 准备数据集和模型                                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: AutoSEP 优化 (autosep/main.py)                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 1. 加载初始 Prompt (prompts/{task}_generate.md)         │    │
│  │ 2. 为训练集图片生成属性描述 (generator.py)               │    │
│  │ 3. 多轮优化循环:                                         │    │
│  │    - 评估当前 Prompt 效果 (scorers.py)                  │    │
│  │    - 从错误样本生成反馈 (optimizers.py)                 │    │
│  │    - 生成改进后的新 Prompt                              │    │
│  │    - 保留 top-K 个最优 Prompt (beam_size)               │    │
│  │ 4. 输出: 优化后的 Prompt + 属性缓存                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│  输出文件:                                                       │
│  - autosep/results/{exp}_{task}/{exp}_train_attr.json           │
│  - autosep/results/{exp}_{task}/{exp}_test_attr.json            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: 分类评估 (classification.py)                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 1. 加载优化后的 Prompt 和属性描述                        │    │
│  │ 2. 对测试集每张图片进行分类预测                          │    │
│  │ 3. 计算 Accuracy / F1 / Confusion Matrix                │    │
│  └─────────────────────────────────────────────────────────┘    │
│  输出文件:                                                       │
│  - autosep/results/{exp}_{task}/evaluate/{exp}_{task}_*.txt     │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  结果: Accuracy / F1 分数                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 运行脚本

| 脚本 | 功能 | 日志前缀 |
|------|------|----------|
| `run_pipeline.sh` | 完整流程（优化 + 评估） | `pipeline_` |
| `run_autosep_optimize.sh` | 仅 Prompt 优化 | `optimize_` |
| `run_classification.sh` | 仅分类评估 | `classify_` |

### 2.3 核心代码调用链

```
run_pipeline.sh / run_autosep_optimize.sh / run_classification.sh
    │
    ├── 读取 config.yaml 配置
    │   ├── dataset: 数据集名称
    │   ├── model: 模型名称 (Qwen2.5-VL-7B-Instruct / Qwen3-VL-8B-Instruct)
    │   └── 设置环境变量 AUTOSEP_MODEL
    │
    ├── [Step 1] autosep/main.py (Prompt 优化)
    │       ├── get_task_class() → tasks.py / data/dataset_loader.py
    │       ├── get_predictor() → predictors.py
    │       ├── generator.AttrGredictor → 生成属性描述
    │       │       └── api_utils.sglang_model() → _get_mllm_bot() → MLLMBot
    │       ├── optimizers.ProTeGi → Prompt 优化
    │       │       └── api_utils.sglang_model() → _get_mllm_bot() → MLLMBot
    │       ├── task.evaluate() → 评估（顺序执行，避免多进程问题）
    │       └── 保存结果:
    │           ├── results/{exp}_{task}/apo_multi_{task}_{exp}.txt (优化后 Prompt)
    │           ├── results/{exp}_{task}/{exp}_train_attr.json (训练集属性)
    │           └── results/{exp}_{task}/{exp}_test_attr.json (测试集属性)
    │
    └── [Step 2] classification.py (分类评估)
            ├── 加载 {exp}_test_attr.json (属性缓存)
            ├── get_task_class() → tasks.py
            ├── get_predictor() → predictors.MultiClassPredictor
            │       └── api_utils.sglang_model() → _get_mllm_bot() → MLLMBot
            └── 输出: results/{exp}_{task}/evaluate/{exp}_{task}_*.txt

模型动态加载流程:
    api_utils._get_mllm_bot(model_name)
        │
        ├── 读取环境变量 AUTOSEP_MODEL
        ├── 根据模型名称动态导入对应模块:
        │   ├── Qwen2.5-VL-7B-Instruct → agents.mllm_bot_qwen_2_5_vl
        │   └── Qwen3-VL-8B-Instruct → agents.mllm_bot_qwen_3_vl
        └── 创建 MLLMBot 单例实例（GPU 模型为单例，不支持多进程）
```

### 2.4 结果文件结构

```
autosep/results/{out_num}_{dataset}/
├── apo_multi_{dataset}_{out_num}.txt   # 优化后的 Prompt（重要！）
├── {out_num}_train_attr.json           # 训练集属性缓存
├── {out_num}_test_attr.json            # 测试集属性缓存（分类评估需要）
└── evaluate/
    └── {out_num}_{dataset}_*.txt       # 分类评估结果
```

**注意**: 
- `classification.py` 需要先运行 `autosep/main.py` 生成 `{exp}_test_attr.json`
- 如果优化过程中断，属性缓存可能不存在，需要重新运行优化

### 2.5 调试比例配置

`config.yaml` 支持调试比例，加速开发验证：

```yaml
autosep:
  train_ratio: 10.0   # 使用 10% 训练集做优化

classification:
  test_ratio: 10.0    # 使用 10% 测试集做评估
```

脚本会自动按百分比缩放样本数：
- `n_train=30, train_ratio=10.0` → 实际使用 3 个样本
- 最小值为 1，避免 0 样本错误

## 三、数据集指南

### 3.1 数据集划分文件格式

每个数据集需要一个 `split_dataset_images.json` 文件，格式如下：

```json
{
  "train": [
    ["类别名称", 类别ID, "相对图片路径"],
    ["001.Black_footed_Albatross", 0, "images/001.Black_footed_Albatross/xxx.jpg"],
    ...
  ],
  "val": [
    ...
  ],
  "test": [
    ...
  ]
}
```

**字段说明：**
- `类别名称`: 字符串，如 `"001.Black_footed_Albatross"`
- `类别ID`: 整数，从 0 开始的类别索引
- `相对图片路径`: 相对于数据集根目录的路径，如 `"images/001.xxx/xxx.jpg"`

### 3.2 数据集目录结构

以 CUB_200_2011 为例：

```
datasets/
└── CUB_200_2011/
    └── CUB_200_2011/
        ├── images/                              # 图片目录
        │   ├── 001.Black_footed_Albatross/
        │   ├── 002.Laysan_Albatross/
        │   └── ...
        ├── images_split/                        # 划分文件目录
        │   └── split_dataset_images.json        # 数据集划分文件
        ├── classes.txt                          # 类别列表
        └── ...
```

### 3.3 支持的数据集列表

| 数据集名称 | 目录名 | 类别数 | 说明 |
|-----------|--------|--------|------|
| CUB-200-2011 | CUB_200_2011 | 200 | 鸟类细粒度分类 |
| Stanford Dogs | dogs_120 | 120 | 狗品种分类 |
| Stanford Cars | car_196 | 196 | 汽车型号分类 |
| FGVC Aircraft | fgvc_aircraft | 100 | 飞机型号分类 |
| Oxford Flowers | flowers_102 | 102 | 花卉分类 |
| Oxford Pets | pet_37 | 37 | 宠物分类 |
| Food-101 | food_101 | 101 | 食物分类 |
| Caltech-101 | caltech101 | 101 | 通用物体分类 |
| Caltech-256 | caltech256 | 256 | 通用物体分类 |
| DTD | dtd | 47 | 纹理分类 |
| EuroSAT | eurosat | 10 | 卫星图像分类 |
| UCF-101 | ucf101 | 101 | 动作识别 |
| SUN397 | SUN397 | 397 | 场景分类 |
| Birdsnap | birdsnap | 500 | 鸟类分类 |
| ImageNet-1K | ImageNet_1k | 1000 | 通用分类 |
| ImageNet-A | ImageNet_A | 200 | 对抗样本 |
| ImageNet-R | ImageNet_R | 200 | 渲染图像 |
| ImageNet-Sketch | ImageNet_Sketch | 1000 | 素描图像 |
| ImageNet-V2 | ImageNet_v2 | 1000 | ImageNet 变体 |

### 3.4 数据集划分文件路径规范

**重要**: 图片路径使用**相对路径**，相对于数据集根目录。

```
工作目录: /home/hdl/project/autosep
数据目录: ./datasets (相对于工作目录)

划分文件位置:
./datasets/{dataset_name}/{dataset_name}/images_split/split_dataset_images.json

图片路径示例 (在 JSON 中):
"images/001.Black_footed_Albatross/xxx.jpg"

实际完整路径:
./datasets/CUB_200_2011/CUB_200_2011/images/001.Black_footed_Albatross/xxx.jpg
```

### 3.5 添加新数据集步骤

1. **创建数据集目录**
   ```bash
   mkdir -p datasets/your_dataset/your_dataset/images
   mkdir -p datasets/your_dataset/your_dataset/images_split
   ```

2. **准备图片**
   - 将图片按类别放入 `images/` 子目录

3. **创建划分文件** `split_dataset_images.json`
   ```json
   {
     "train": [
       ["class_name_1", 0, "images/class_name_1/img1.jpg"],
       ["class_name_1", 0, "images/class_name_1/img2.jpg"],
       ["class_name_2", 1, "images/class_name_2/img1.jpg"],
       ...
     ],
     "val": [...],
     "test": [...]
   }
   ```
   
   **字段说明**:
   - 第1个元素: 类别名称 (字符串)
   - 第2个元素: 类别ID (整数，从0开始)
   - 第3个元素: 图片相对路径 (相对于 `datasets/{name}/{name}/`)

4. **在 config.yaml 中添加数据集**
   ```yaml
   datasets:
     - name: your_dataset
       enabled: true
       description: "你的数据集描述"
   ```

5. **运行测试**
   ```bash
   bash scripts/run_pipeline.sh
   ```

## 四、快速开始

### 4.1 一键运行

```bash
# 1. 安装依赖
pip install yq  # 用于解析 YAML

# 2. 修改配置 (指定数据集名称和环境)
vim scripts/config.yaml
# 设置 dataset: cub  (或 dog, flower, car 等)
# 设置 environment.conda_path 和 environment.conda_env

# 3. 后台运行（推荐，无需手动激活 conda）
bash scripts/run_pipeline.sh

# 4. 前台运行（用于调试）
bash scripts/run_pipeline.sh --foreground
```

### 4.2 查看日志

```bash
# 实时查看日志
tail -f logs/pipeline_cub.log

# 日志文件命名规则：
# - pipeline_{dataset}.log        # 首次运行
# - pipeline_{dataset}(1).log     # 第二次运行（递增）
```

### 4.3 查看结果

```bash
# 结果文件位置
cat autosep/results/{exp}_{task}/evaluate/{exp}_{task}_*.txt

# 查看准确率
grep "Accuracy" autosep/results/*/evaluate/*.txt
```

## 五、配置说明

详见 `scripts/config.yaml`，主要配置项：

```yaml
# 环境配置
environment:
  conda_path: /home/hdl/miniconda3  # conda 安装路径
  conda_env: autosep                 # conda 环境名称

# 路径配置 (支持相对路径)
paths:
  data_dir: ./datasets  # 数据集目录
  log_dir: ./logs       # 日志目录
  gpu: 3                # GPU 编号

# 数据集名称 (简称)
# 细粒度: cub, dog, flower, car, pet, aircraft, food, birdsnap
# 通用:   caltech101, caltech256, dtd, eurosat, ucf, sun397
# ImageNet: imagenet_1k, imagenet_a, imagenet_r, imagenet_sketch, imagenet_v2
dataset: cub

# 模型名称
# 支持: Qwen2.5-VL-7B-Instruct (默认), Qwen3-VL-8B-Instruct
model: Qwen2.5-VL-7B-Instruct

# AutoSEP 优化参数
autosep:
  n_train: 30
  rounds: 6
  beam_size: 4
  ...

# 分类评估参数
classification:
  mode: test
  n_test: 30
  ...

# 实验编号
experiment:
  out_num: 1
```

## 六、脚本使用指南

详见 `scripts/运行全流程脚本指南.md`，包含：
- 脚本执行流程图
- 配置文件详细说明
- 后台运行和日志管理
- 常见问题解答
